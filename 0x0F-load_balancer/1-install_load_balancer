#!/usr/bin/env bash
# Install and configure HAproxy on your lb-01 server.

if [ "$(dpkg-query -W -f='${Status}' haproxy 2>/dev/null | grep -c "ok installed")" -eq 0 ];
then
	sudo apt-get update -y
	sudo apt-get install -y haproxy
fi

my_config="
global
	log /dev/log	local0
	log /dev/log	local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
	stats timeout 30s
	user haproxy
	group haproxy

	daemon
	maxconn 256

defaults
	mode http
	timeout connect 5s
	timeout client 50s
	timeout server 50s
	log	global
	option	httplog
	option	dontlognull
	errorfile 400 /etc/haproxy/errors/400.http
	errorfile 403 /etc/haproxy/errors/403.http
	errorfile 408 /etc/haproxy/errors/408.http
	errorfile 500 /etc/haproxy/errors/500.http
	errorfile 502 /etc/haproxy/errors/502.http
	errorfile 503 /etc/haproxy/errors/503.http
	errorfile 504 /etc/haproxy/errors/504.http


frontend frontends
	bind *:80
	default_backend backends

backend backends
	balance roundrobin
	server web-01 54.144.238.161 check
	server web-02 100.25.154.52 check
	"

echo -e "$my_config" | sudo tee /etc/haproxy/my_config.cfg > /dev/null

sudo haproxy -c -f /etc/haproxy/my_config.cfg

sudo systemctl start haproxy
sudo systemctl enable haproxy
